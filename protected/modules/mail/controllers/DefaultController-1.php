<?php
class DefaultController extends \application\components\controllers\AdminMainController
{
  public function actionSend($step = 0)
  {
    set_time_limit(84600);
    error_reporting(E_ALL & ~E_DEPRECATED);

    $template = 'runetid-html-1';
    $isHTML = true;

//    $arPromo = file($_SERVER['DOCUMENT_ROOT'] . '/files/ext/2013-04-15/promo_1000_rif.csv');

    $logPath = \Yii::getPathOfAlias('application').DIRECTORY_SEPARATOR.'..'.DIRECTORY_SEPARATOR.'data'.DIRECTORY_SEPARATOR;
    $fp = fopen($logPath.$template.'.log',"a+");
    $j = 0;

    $criteria = new \CDbCriteria();

    // ГеоВыборка
    /*
    $criteria->with = array(
        'LinkAddress' => array('together' => true, 'select' => false),
        'LinkAddress.Address' => array('together' => true, 'select' => false),
        'LinkAddress.Address.City' => array('together' => true, 'select' => false),

        'Participants' => array('together' => true, 'select' => false),
        'Settings' => array('select' => false),
    );
    $criteria->addCondition('"Participants"."EventId" IN (128,218,339) OR "City"."Id" IN (3538,3354,4210,4238,5242,4650,5005)');
    */
    
    // Обычная выборка пользователей [по мероприятиям]
//    $arUserId = array(122026,121709,83813,50794,118064,18177,30833,74893,4295,121794,31835,47983,110822,83600,122140,127449,94719,123464,120930,82149,126568,122461,121625,54766,97080,60317,65501,126567,37676,122274,123819,127514,121334,94754,14356,123778,106121,122418,12423,127795,29110,12184,122173,10780,28373,121514,109002,127411,125902,10543,126534,121996,76558,53057,32848,80699,94859,102711,94115,127812,127220,123545,120883,110141,103138,122611,75304,93671,95059,123265,120594,94654,85661,16051,35797,103185,122452,126618,10113,34373,121789,96908,76709,126408,117992,122198,121806,123130,93502,27653,95833,121305,50619,117972,120561,96728,89211,21535,53662,122203,14403,122521,118083,75441,15444,76524,13706,31754,23256,48932,96611,60872,107587,123771,127695,104595,121491,10175,120844,121555,76260,76379,120882,126275,127351,69844,122543,95966,108203,122819,111541,3810,54648,123561,118837,8236,122442,123335,116108,92296,116009,123498,123815,126619,13285,127835,54330,6706,122646,105580,118093,123389,94810,80735,123140,12913,123818,48446,96281,118200,12220,127777,44405,121073,77546,122409,19457,122861,40079,123603,49089,111417,120492,53288,95290,55798,121527,14435,117994,121870,118836,72622,10156,32924,116107,74411,112544,103500,97854,118062,36751,122516,77340,8813,127422,121865,122817,62063,53466,127480,127841,50552,53183,126258,63004,49366,122712,81721,121631,94556,7218,127784,127534,105530,40259,123334,122965,52652,122180,74381,126262,120846,64401,121412,105574,122498,30712,126527,52965,17995,74444,31639,40892,88186,72565,83665,33703,12472,110109,32883,118021,121772,35071,72522,121846,117996,121778,32474,102093,34163,9328,70401,116547,13150,50255,123550,122579,127594,39815,80963,101763,50277,67484,8282,18589,94615,8489,105525,122278,122392,123835,70213,78462,127315,123308,126407,74223,122300,94081,120565,123519,64516,105850,13402,122660,95903,94373,104589,126174,97688,92658,121795,101802,97020,9646,76403,122551,10202,126543,41878,30445,118091,109763,127569,120908,105333,95247,14586,122467,17262,95834,75639,95185,33839,120688,106086,6990,58602,8416,14194,126532,83342,72632,111169,50128,41175,84997,10222,13577,123291,63956,123503,96237,97381,121553,96887,49150,122647,127305,96958,118843,122546,87539,13800,53672,50909,127542,53267,127593,50802,72543,11494,75260,74358,121185,21630,126403,49912,120566,76176,8914,15353,91915,122520,28923,122188,96879,125929,126315,115160,103140,2406,121078,118057,126528,76591,74318,127173,7982,31279,127409,10415,94969,121805,122867,96329,89425,21018,73897,70305,105368,127522,123555,126348,106877,125906,121844,118147,120557,90890,10071,122272,76779,12159,81708,123760,120654,72931,127277,96343,29984,38899,11357,118186,120527,126570,123141,126214,127565,93918,36773,94241,29291,60821,123554,52675,122407,126606,7227,121855,70689,33278,122335,32040,32386,10533,122582,123785,123331,125922,122387,73534,67620,123319,120976,75881,53694,93633,17304,16376,33973,9190,41981,29890,93936,103967,94660,7657,95611,10249,93846,14417,122465,123741,103307,123598,73779,103936,29486,1684,72545,74984,122118,10227,122170,123495,126430,120646,95624,103868,126212,126519,96027,105939,52065,101739,42220,126206,77461,122320,73770,126537,122638,60865,73000,122538,126181,10318,36903,27870,53842,13475,115366,91252,39992,76532,29141,121684,126309,97340,23115,29623,80243,100221,109779,122860,87026,121854,52673,12806,122494,123481,85265,96752,61178,74717,127302,127525,120501,123436,93381,120738,30348,13271,121131,120601,122405,104524,121437,38095,7399,126263,53316,93050,9335,101044,121862,122005,123751,35038,117963,126339,20920,98083,122265,122237,87215,96074,122614,33182,87630,16007,122148,30379,102418,121616,126178,123775,31080,54072,118063,76028,116588,123553,120841,123591,99690,121773,74277,116701,120902,30922,94753,126109,122298,126603,126314,85050,120571,30475,87505,101954,18370,33125,13140,88470,74713,102371,95931,103054,93455,84158,72544,89674,96730,106634,123750,80941,120909,52951,72832,28975,39134,94595,25898,127281,10325,122423,10082,83593,50739,3460,86137,81232,45282,122711,123382,123735,30654,54501,80340,118035,41549,93922,96763,118839,70625,10651,117949,110785,123406,102660,49155,14170,50431,78142,86535,120794,13233,127520,121067,106116,67451,112134,96280,127538,33738,122476,120190,7596,18442,127358,29101,77827,60935,94767,90741,18363,64199,121840,95224,126624,122451,94500,96033,127418,81088,122604,126302,31937,118009,120493,8780,10259,95187,103495,123830,122820,121896,95175,95649,122842,121997,121809,102970,39399,54180,94119,35819,8550,24361,95038,83970,125951,111843,20623,53975,15497,122629,96772,120907,123357,36321,120912,103055,80861,15870,56532,73923,122477,102988,126595,121771,121938,32643,122610,120582,13459,120784,121535,123043,34313,32871,74675,127489,120911,95882,34267,122907,127576,15937,86770,12176,123323,120288,121777,8133,122534,121130,92235,62900,9164,122042,14876,72010,50688,97676,105573,12988,32601,83892,18529,30033,74087,105854,51188,12576,121636,45217,12914,117962,120560,108165,104428,40304,96605,120491,122635,31716,120579,115651,75316,122086,8272,50625,118841,33231,118007,121326,103184,126326,126684,8691,85197,28472,33371,123362,21071,121826,50372,87920,95884,126512,564,87128,16112,122627,2128,122736,123305,103340,84828,29915,30791,84927,93101,103805,35552,123052,122628,7754,95893,28511,95637,32233,120465,17274,39627,126369,44644,122540,14029,54885,101995,126623,106618,127368,50355,122756,122318,123238,76048,87766,127174,126562,16025,6812,126566,40346,58175,52607,100520,52872,127530,122536,126615,126247,95885,35243,122483,96266,121857,123349,120653,112288,53879,127813,85517,50745,33032,93844,50417,95494,30095,123203,13876,99207,78388,72563,83322,122253,121799,93335,120876,120881,121313,122585,111390,69988,127691,93089,38760,10818,87242,122768,94643,122369,121740,126351,61408,122545,5802,110684,96254,127286,18061,54724,96882,12938,126323,64579,91689,96663,123063,123040,13807,123597,52865,96906,84788,121436,127773,62171,42530,123343,19670,85316,2131,13423,40693,126261,95001,118786,72838,125927,107882,120762,81081,126673,127320,31855,35872,122229,9532,123131,50358,14393,13099,77180,98119,106815,122632,121916,122302,83781,49310,92051,122453,104529,127493,121863,95415,80774,92662,122808,9160,120782,126228,102640,35328,122160,6214,123749,122497,123178,50227,125960,9315,121556,122872,121717,121132,122459,126264,29474,28880,123383,28985,122924,101751,31809,53958,70947,103339,17363,122642,120559,94884,86209,121944,18517,80745,86323,29251,118797,126207,80864,95203,121781,16984,108701,122186,74765,116306,48500,53482,122049,121615,122921,118810,95473,43993,125905,74390,122938,58591,121861,31652,43013,122252,121766,122798,43260,123822,104562,53726,72875,120513,122542,67083,21701,95188,98888,65657,65095,117964,121715,105811,122985,84507,48946,8492,95263,71605,29470,122344,115656,120997,123088,34446,75451,120497,121868,78552,127779,60623,96337,95020,121068,122227,120856,99227,121564,125949,73826,121822,45314,71267,102475,117916,127805,9128,121009,123782,102964,80573,50420,126312,34877,105169,34838,126665,127767,127768,71507,121785,118059,121424,102424,33400,96094,61189,122277,49236,126311,120490,13037,120949,85605,120890,96916,43818,43155,63749,98739,33895,13048,122254,127177,123393,56369,123280,76926,109727,123269,77830,123526,96272,54019,121802,121866,9519,40671,91376,61508,89603,75053,85899,127595,3366,122548,127235,9125,122131,30014,95039,33396,73467,91518,16362,53426,12529,121683,75529,122742,16033,51957,120843,121534,122515,17841,18096,103051,117991,122408,92813,64164,48998,123320,127342,117296,81910,73208,96110,127254,125932,73394,65334,21694,67621,29566,50150,12850,95967,122624,106097,126542,94259,65361,122079,31771,95961,95540,106551,121677,13317,94518,52593,126680,94911,24202,28449,127176,127421,81829,92845,27360,37319,72366,12212,73050,121796,120770,16911,53907,122937,121668,13070,74104,85523,72088,97569,102864,122802,126621,72665,94961,14857,107399,123737,31121,38463,120921,121705,94113,61845,107566,57539,7641,122295,126313,12671,123551,122264,123126,95820,53980,72505,95034,64294,82572,10515,95593,75371,116714,9072,61218,126685,42599,103221,123533,118840,95043,8576,6078,100490,97744,86130,122523,94640,73859,34191,60516,126232,103867,39095,81016,75024,73589,54574,76426,127693,121626,75662,95291,10387,116389,96144,122417,96092,121763,120955,48936,96001,118061,10143,127536,122380,50280,122179,126513,36085,2158,86052,30753,73723,95556,75353,125904,105561,73940,30923,109876,123477,127175,126608,96964,94461,122838,111840,75345,58605,81924,20066,73942,34661,5435,74557,122525,31259,122415,122740,108673,84418,18590,121627,126668,53990,70824,123789,122447,12833,87703,118842,126557,12542,85837,122828,13122,73944,105858,93008,104754,53675,72361,78567,31981,55583,122161,18793,75189,34133,16045,14433,123324,123179,72676,81607,31409,120494,118086,20170,111365,88039,126292,120914,53676,96725,48991,31228,127631,115072,121537,126211,12438,101375,32813,56049,94715,28928,126565,121825,53709,43314,126627,70950,50693,101740,121024,121845,123761,44357,122238,28665,109839,74728,77138,8982,121800,86910,40406,121803,87856,126431,76256,32478,21664,13255,29522,122902,122705,105236,121507,73686,120795,92287,43786,9689,122754,126569,75950,96401,72542,121801,122448,116186,127782,50813,13252,122024,42493,122737,31459,117965,31495,28956,105291,126572,103891,94208,12101,9197,97527,123158,86568,126691,105701,121988,65041,118087,121746,126672,126252,126636,118084,53613,110470,84407,74249,51908,31626,50793,14415,127425,122388,102445,73837,27771,13888,80934,49583,122910,97650,72380,126518,103822,121711,94811,122832,94333,123736,87523,74559,82510,30785,122878,95410,53836,102998,127528,20554,121392,44695,122440,78997,94657,127721,121606,123754,73821,57291,44949,54125,33206,102315,122630,74716,24464,15505,28617,34441,125921,12613,87794,122169,33997,121832,110228,101652,95294,48944,21113,47709,126327,126689,121219,43183,122421,123606,120936);

    $criteria->with = array(
      'Participants' => array('together' => true, 'select' => false),
      'Participants.Role' => array('together' => true, 'select' => false),
      'Settings' => array('select' => false)
    );

//    $criteria->addInCondition('"Participants"."EventId"', array(248));
//    $criteria->addInCondition('"Participants"."RoleId"', array(11));
    
    $criteria->distinct = true;
    $criteria->addCondition('NOT "Settings"."UnsubscribeAll"');
    $criteria->addCondition('"t"."Visible"');
    
    $criteria->addInCondition('"t"."RunetId"', array(12953));
    
//    echo \user\models\User::model()->count($criteria);
//    exit();

    $criteria->limit = 500;
    $criteria->order = '"t"."RunetId" ASC';
    $criteria->offset = $step * $criteria->limit;
    $users = \user\models\User::model()->findAll($criteria);
    if (!empty($users))
    {
//      $counter = 0;
      foreach ($users as $user)
      {
        // ПИСЬМО
//        $body = $this->renderPartial($template, array('user' => $user), true);
        $body = $this->renderPartial($template, array('user' => $user, 'regLink' => $this->getRegLink($user)), true);
//        $body = $this->renderPartial($template, array('user' => $user, 'regLink' => $this->getRegLink($user), 'role' => $user->Participants[0]->Role->Title), true);
        $mail = new \ext\mailer\PHPMailer(false);
        $mail->Mailer = 'mail';
        $mail->ParamOdq = true;
        $mail->ContentType = ($isHTML) ? 'text/html' : 'text/plain';
        $mail->IsHTML($isHTML);
        
        $email = $user->Email;

        if ($j == 300) { sleep(1); $j = 0; }; $j++;

        if (!filter_var($email, FILTER_VALIDATE_EMAIL))
        {
          continue;
        }

        /*
        if (preg_match("/@ashmanov.com/i", $email))
        {
          print 'is @Ashmanov<br />';
          continue;
        }
        */

        $mail->AddAddress($email);
        $mail->SetFrom('users@runet-id.com', '—RUNET—ID—', false);
        $mail->CharSet = 'utf-8';
        $mail->Subject = '=?UTF-8?B?'. base64_encode('RUNET-ID: новости отраслевых мероприятий') .'?=';
        $mail->Body = $body;

//        $mail->AddAttachment($_SERVER['DOCUMENT_ROOT'] . '/files/ext/2013-03-28/newspaper-1.pdf');

        $mail->Send();

        fwrite($fp, $user->RunetId . ' - '. $email . "\n");
//        fwrite($fp, $user->RunetId.' - '.$email.' - '.$arPromo[$counter]."\n");
//        $counter++;
      }
      fwrite($fp, "\n\n\n" . sizeof($users) . "\n\n\n");
      fclose($fp);
//      echo $this->createUrl('/mail/default/send', array('step' => $step+1));
      echo '<html><head><meta http-equiv="REFRESH" content="0; url='.$this->createUrl('/mail/default/send', array('step' => $step+1)).'"></head><body></body></html>';
    }
    else
    {
      echo 'Рассылка ушла!';
    }
  }

  private function getRegLink($user)
  {
    $runetId = $user->RunetId;
    $secret = 'xggMpIQINvHqR0QlZgZa';

   	$hash = substr(md5($runetId.$secret), 0, 16);

    return 'http://2013.sp-ic.ru/my/'.$runetId.'/'.$hash .'/';
//    return 'http://2013.russianinternetforum.ru/my/'.$runetId.'/'.$hash .'/?redirect=/my/payment1.php';
  }

}
